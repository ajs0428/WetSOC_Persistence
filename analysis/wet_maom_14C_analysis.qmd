---
title: "Wetland MAOM 14C Analysis"
format: html
---

```{r}
#| label: setup

library(tidyverse)
library(lme4)
library(car)
library(MASS)
library(lmerTest)
library(emmeans)
library(ppcor)
library(ggcorrplot)
library(RColorBrewer)
library(webshot)
library(kableExtra)
library(formatR)
library(openxlsx)
library(here)

knitr::opts_chunk$set(fig.align = "center", fig.show = "hold", dpi = 100,
                      tidy.opts = list(width.cutoff = 60), 
                      tidy = T, 
                      collapse = TRUE, 
                      echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE)
knitr::opts_knit$set(root.dir = '/Users/Anthony/OneDrive - UW/University of Washington/Data and Modeling/')

#knitr::knit_hooks$set(webgl = hook_webgl)
rgl::setupKnitr(autoprint = TRUE)

r.sq <- function(y,y.fitted){
    res <- y-y.fitted
    1-sum(res^2)/sum((y-mean(y))^2)
}

check_assump_func <- function(model) {
  plot(model)
  plot(model, resid(.) ~ fitted(.)|sample_ID, abline = 0, ylab = "Model Residuals", xlab = "Fitted Model")
  
  qqnorm(resid(model))
  qqline(resid(model))
  
  lev <- hat(model.matrix(model))
  plot(resid(model) ~ lev, xlab = "Leverage", ylab = "Model Residuals")
  
  cd <- cooks.distance(model)
  plot(x = lev, y = cd, xlab = "Leverage", ylab = "Cooks Distance", ylim = c(0,1))
  # legend("topleft",
  #        legend = "Cooks Distance", 
  #        text.col = "blue",
  #        pch = 1,
  #        col = "blue")
  
  hist(as.vector(unlist(ranef(model)$sample_ID)), main = "", xlab = "Random Effect Conditional Means")
}
```


## Data Import 
```{r}
HLEF_HFF_14C_DC_AO_trans <- read.csv( here("data/dataframes/HLEF_HFF_14C_DC_AO.csv")) #|> glimpse()
glimpse(HLEF_HFF_14C_DC_AO_trans)
```



### MAOM-∆14C modeling to find important variables

```{r}
lmAll_MAOM14C_HPU <- lmer((delta_14C_adj) ~ depth_cm + carbon_perc + clay + ph + 
                          Fe_mg_gSoil_AO + Fe_mg_gSoil_DC + Al_mg_gSoil_AO + Al_mg_gSoil_DC +
                          (1|sample_ID), 
                     data = HLEF_HFF_14C_DC_AO_trans, REML = F
                     #family = Gamma(link = "log"),
                     #control = glmerControl(optimizer = "Nelder_Mead")
                     )
summary(lmAll_MAOM14C_HPU)
Anova(lmAll_MAOM14C_HPU, type = 3)
```

Parsimonious model
```{r}
lmAll_MAOM14C <- lmer((delta_14C_adj) ~ depth_cm + ph + clay+
                           Fe_mg_gSoil_DC + 
                          (1|sample_ID), 
                     data = HLEF_HFF_14C_DC_AO_trans, REML = F
                     #family = Gamma(link = "log"),
                     #control = glmerControl(optimizer = "Nelder_Mead")
                     )
summary(lmAll_MAOM14C)
Anova(lmAll_MAOM14C, type = 3)
AIC(lmAll_MAOM14C)


saveRDS(lmAll_MAOM14C, file = "WetSOC_Persistence/analysis/models/MAOM14C_All_selection.rds")

```


### What controls MAOM-C

- Based on the previous analysis the factors should include 
    
    - HPU
    - carbon%
    - TOC - too correlated with carbon%
    - pH
    - FeDC
    - AlDC
- Interactions between HPU, depth


```{r}


maoc_drv_lm <- glmer((HFF_mgC_gSoil) ~ HPU*carbon_perc*depth_cm+Fe_mg_gSoil_AO+Al_mg_gSoil_DC*ph + (1|sample_ID), 
                        data = HLEF_HFF_14C_DC_AO_trans,
                     family = Gamma(link = "log"))
maoc_drv_lm2 <- glmer((HFF_mgC_gSoil) ~ carbon_perc+depth_cm+Fe_mg_gSoil_AO+Al_mg_gSoil_DC + (1|sample_ID), 
                        data = HLEF_HFF_14C_DC_AO_trans,
                     family = Gamma(link = "log"))
anova(maoc_drv_lm, maoc_drv_lm2)
summary(maoc_drv_lm)
summary(maoc_drv_lm2)
Anova(maoc_drv_lm)
Anova(maoc_drv_lm2)

car::Anova(maoc_drv_lm, type = "III")
#emmeans(maoc_drv_lm, pairwise ~ HPU)
rsq::rsq.glmm(maoc_drv_lm)
r.sq(y = HLEF_HFF_14C_DC_AO_trans$HFF_mgC_gSoil,
     y.fitted = (fitted(maoc_drv_lm)))

saveRDS(maoc_drv_lm, "WetSOC_Persistence/analysis/models/maoc_drv_lm.rds")
```


### MAOM-C vs. MAOM-∆14C

```{r}
HLEF_HFF_14C_DC_AO_ratio <- HLEF_HFF_14C_DC_AO_trans |> mutate(SOC_MAOM_content_ratio = HFF_mgC_gSoil/SOC_mgC_gSoil) 
  #filter(SOC_MAOM_content_ratio < 1) |> 

lm_MAOM_MAOM14C <- lmer((delta_14C_adj) ~ HFF_mgC_gSoil + 
                          (1|sample_ID), 
                     data = HLEF_HFF_14C_DC_AO_ratio, REML = F
                     #family = Gamma(link = "log"),
                     #control = glmerControl(optimizer = "Nelder_Mead")
                     )
summary(lm_MAOM_MAOM14C)
Anova(lm_MAOM_MAOM14C, type = 3)

lm_MAOMratio_MAOM14C <- lmer((delta_14C_adj) ~ SOC_MAOM_content_ratio + 
                          (1|sample_ID), 
                     data = HLEF_HFF_14C_DC_AO_ratio, REML = F
                     #family = Gamma(link = "log"),
                     #control = glmerControl(optimizer = "Nelder_Mead")
                     )
summary(lm_MAOMratio_MAOM14C)
Anova(lm_MAOMratio_MAOM14C, type = 3)

```





### What controls the persistence of MAOM-C? 


    

```{r}

maoc_14C_drv_lm <- glmer((delta_14C_adj) ~ HPU+clay*depth_cm*Al_mg_gSoil_DC+carbon_perc + (1|sample_ID), 
                        data = HLEF_HFF_14C_DC_AO_trans,
                        family = gaussian(link = "identity"))
maoc_14C_drv_lm2 <- glmer((delta_14C_adj) ~  HPU*depth_cm*Al_mg_gSoil_DC+clay+carbon_perc + (1|sample_ID), 
                        data = HLEF_HFF_14C_DC_AO_trans,
                        family = gaussian(link = "identity"))
anova(maoc_14C_drv_lm, maoc_14C_drv_lm2)
summary(maoc_14C_drv_lm)
summary(maoc_14C_drv_lm2)
Anova(maoc_14C_drv_lm)
Anova(maoc_14C_drv_lm2)

car::Anova(maoc_14C_drv_lm2, type = "III")
#emmeans(maoc_14C_drv_lm, pairwise ~ HPU)
rsq::rsq.glmm(maoc_14C_drv_lm2)
r.sq(y = HLEF_HFF_14C_DC_AO_trans$delta_14C_adj,
     y.fitted = (fitted(maoc_14C_drv_lm2)))

saveRDS(maoc_14C_drv_lm2, "WetSOC_Persistence/analysis/models/maoc_14C_drv_lm.rds")

```


### Principal component analysis 

```{r}
library(ggrepel)
pca <- prcomp(HLEF_HFF_14C_DC_AO_trans |> dplyr::select(#HFF_mgC_gSoil, delta_14C_adj, 
                                                             depth_cm, carbon_perc, TOC, bulkCN, ph,
                                                             clay,Fe_mg_gSoil_AO, Fe_mg_gSoil_DC, 
                                                             Al_mg_gSoil_AO, Al_mg_gSoil_DC) |> 
                scale())
# Extract the scores (principal components)
pca_scores <- as.data.frame(pca$x)
# Add the grouping factor to the scores
pca_scores$group <- HLEF_HFF_14C_DC_AO_trans$HPU

# Calculate variance explained
var_explained <- pca$sdev^2 / sum(pca$sdev^2) * 100

# Create a scree plot to see variance explained by each component
scree_data <- data.frame(
  Component = factor(1:length(var_explained), levels = 1:length(var_explained)),
  Variance = var_explained
)

scree_plot <- ggplot(scree_data, aes(x = Component, y = Variance)) +
  geom_bar(stat = "identity") +
  labs(title = "Scree Plot",
       x = "Principal Component",
       y = "Variance Explained (%)") +
  theme_minimal()

# Plot the first two PCA axes colored by group
pca_plot <- ggplot(pca_scores, aes(x = PC1, y = PC2, color = group)) +
  geom_point(size = 3, alpha = 0.7) +
  stat_ellipse(level = 0.95) +  # Add confidence ellipses
  labs(
    title = "PCA Plot",
    x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
    y = paste0("PC2 (", round(var_explained[2], 1), "%)"),
    color = "Group"
  ) +
  theme_minimal() +
  theme(legend.position = "right")

# Display the scree plot
print(scree_plot)

# Display the PCA plot
print(pca_plot)

# Optional: Add loadings to the plot
# Extract loadings
loadings <- as.data.frame(pca$rotation)
loadings$variable <- rownames(loadings)

# Create a biplot (combining scores and loadings)
biplot <- ggplot() +
  # Plot scores
  geom_point(data = pca_scores, aes(x = PC1, y = PC2, color = group), size = 3, alpha = 0.7) +
  # Plot loadings as arrows
  geom_segment(data = loadings, aes(x = 0, y = 0, xend = PC1 * 5, yend = PC2 * 5),
               arrow = arrow(length = unit(0.2, "cm")), color = "darkgray") +
  # Add labels for loadings
  geom_text_repel(data = loadings, aes(x = PC1 * 5, y = PC2 * 5, label = variable),
                 color = "black", size = 3) +
  # Add axis labels with variance explained
  labs(
    title = "PCA Biplot",
    x = paste0("PC1 (", round(var_explained[1], 1), "%)"),
    y = paste0("PC2 (", round(var_explained[2], 1), "%)"),
    color = "Group"
  ) +
  theme_minimal()

# Display the biplot
print(biplot)

# Summary of PCA results
summary(pca)
```




Is there an effect of landscape type on MAOC and MAOC:SOC?

- First look at depth

```{r}
# Define parameters
k <- 300  # Steepness factor
a <- 0    # Horizontal shift
b <- 25    # Vertical shift

ggplot(data = HLEF_HFF, aes(y = depth_cm, x = HFF_mgC_gSoil)) +
    geom_point() +
    #geom_smooth(se = F, span = 10, fullrange = TRUE) +
  geom_function(
    fun = function(x) k/(x-a) + b, #k/(sinh(x)-a) +b,
    color = "purple",
    size = 1.2,
    n = 500
  )  + 
    ylim(0, 300) +
    scale_y_reverse()

ggplot() + 
    geom_function(
    fun = function(x) -50*log(x+2) + 210,#k/(abs(x)-a) + b, #k/(sinh(x)-a) +b,
    color = "purple",
    size = 1.2,
    n = 500
  ) + 
    ylim(0, 300) +
    xlim(0, 60)
```